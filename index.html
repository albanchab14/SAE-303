<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Experience - EVOLUTION CROWD</title>
  
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  
  <style> 
    body { margin: 0; background-color: black; overflow: hidden; font-family: sans-serif; } 
    video { z-index: -1 !important; transition: opacity 0.5s; }

    /* --- UI GENERALE --- */
    #back-btn {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        padding: 12px 24px; background-color: #CC0000; color: white;
        font-weight: bold; border: 2px solid white;
        border-radius: 30px; z-index: 9999; cursor: pointer; display: none;
    }

    /* --- UI TOP 6 --- */
    #switch-btn-top6 {
        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
        padding: 15px 30px; background-color: #2c3e50; color: white;
        font-weight: bold; border: 2px solid #C68F00;
        border-radius: 30px; z-index: 9999; cursor: pointer; display: none; 
    }

    /* --- UI EVOLUTION --- */
    #evolution-ui {
        position: fixed; bottom: 20px; width: 100%; text-align: center;
        z-index: 9999; display: none; pointer-events: none; 
    }

    .timeline-container {
        pointer-events: auto;
        display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;
    }
    
    .year-btn {
        padding: 10px 20px; background-color: rgba(0,0,0,0.7); color: white;
        border: 2px solid #555; border-radius: 20px; cursor: pointer;
        font-weight: bold; transition: all 0.3s;
    }
    .year-btn.active {
        background-color: white; color: black; border-color: white; transform: scale(1.1);
    }

    .type-switch-evo {
        pointer-events: auto;
        display: inline-block;
        padding: 10px 25px; background-color: #C68F00; color: white;
        font-weight: bold, border: 2px solid white; border-radius: 30px; 
        cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.5);
    }
    .mode-apprenti-style {
        background-color: #FF8A65 !important; color: black !important;
    }

    /* --- INTRO SCREEN --- */
    #intro-screen {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        pointer-events: auto;
        backdrop-filter: blur(8px);
    }

    .intro-content {
        background: rgba(20, 20, 20, 0.95);
        border: 3px solid #C68F00;
        border-radius: 20px;
        padding: 40px;
        max-width: 600px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(198, 143, 0, 0.3);
    }

    .intro-content h1 {
        font-size: 2.5em;
        color: #C68F00;
        margin: 0 0 20px 0;
        font-weight: bold;
    }

    .intro-content p {
        font-size: 1.1em;
        color: #ddd;
        line-height: 1.6;
        margin: 0 0 30px 0;
    }

    #intro-btn {
        padding: 15px 40px;
        background-color: #C68F00;
        color: white;
        font-weight: bold;
        font-size: 1.1em;
        border: 2px solid white;
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.3s;
    }

    #intro-btn:hover {
        background-color: #FF8A65;
        transform: scale(1.05);
    }

  </style>

  <script>
    AFRAME.registerComponent('procedural-building', {
      schema: {
        height: {type: 'number', default: 1}, 
        width: {type: 'number', default: 0.3}, 
        color: {type: 'color', default: '#AAA'}, 
        offset: {type: 'number', default: 0} 
      },
      init: function() {
        const data = this.data;
        const el = this.el;
        el.innerHTML = '';

        // BÃ¢timent
        const building = document.createElement('a-box');
        building.setAttribute('width', data.width);
        building.setAttribute('height', data.height);
        building.setAttribute('depth', 0.15); 
        building.setAttribute('position', `0 ${data.height / 2} 0`);
        building.setAttribute('color', data.color);
        // Animation simple
        building.setAttribute('animation', `property: scale; from: 1 0 1; to: 1 1 1; dur: 800; easing: easeOutElastic`);
        el.appendChild(building);

        // FenÃªtres
        const winColor = '#333'; 
        const winW = data.width * 0.20; 
        const winH = Math.min(0.15, data.height * 0.1); 
        const depthOffset = 0.08; 
        
        let floors = Math.floor(data.height / 0.4); 
        if(floors < 1) floors = 1;

        for(let f=0; f<floors; f++) {
            const yPos = (f * 0.4) + 0.2;
            if(yPos > data.height - 0.1) break;
            const w1 = document.createElement('a-plane');
            w1.setAttribute('color', winColor);
            w1.setAttribute('width', winW);
            w1.setAttribute('height', winH);
            w1.setAttribute('position', `-${data.width*0.25} ${yPos} ${depthOffset}`);
            el.appendChild(w1);
            const w2 = document.createElement('a-plane');
            w2.setAttribute('color', winColor);
            w2.setAttribute('width', winW);
            w2.setAttribute('height', winH);
            w2.setAttribute('position', `${data.width*0.25} ${yPos} ${depthOffset}`);
            el.appendChild(w2);
        }
      },
      tick: function (time, timeDelta) {
        let t = (time / 1000 * 2.0) + this.data.offset; 
        let scaleFactor = 0.98 + (Math.sin(t) + 1) * (1.0 - 0.98) / 2;
        this.el.object3D.scale.x = scaleFactor;
        this.el.object3D.scale.z = scaleFactor;
      }
    });
  </script>
</head>
<body>

  <div id="intro-screen">
      <div class="intro-content">
          <h1>ðŸŽ“ L'enseignement supÃ©rieur Ã  BÃ©ziers</h1>
          <p>Explorez l'Ã©volution de la population Ã©tudiante et les Ã©tablissements de formation supÃ©rieure. Scannez la cible AR pour dÃ©couvrir nos donnÃ©es interactives en rÃ©alitÃ© augmentÃ©e.</p>
          <button id="intro-btn" onclick="startARExperience()">AccÃ©der Ã  l'affiche ðŸ“±</button>
      </div>
  </div>

  <div id="back-btn">RETOUR SCAN ðŸ“·</div>
  <div id="switch-btn-top6" onclick="toggleTop6Mode()">VOIR APPRENTIS ðŸ”„</div>

  <div id="evolution-ui">
      <div id="evo-type-btn" class="type-switch-evo" onclick="toggleEvolutionType()">VOIR APPRENTIS ðŸ”„</div>
      <br><br>
      <div class="timeline-container">
          <div id="btn-2015" class="year-btn" onclick="selectYear(2015)">2015</div>
          <div id="btn-2021" class="year-btn" onclick="selectYear(2021)">2021</div>
          <div id="btn-2026" class="year-btn" onclick="selectYear(2026)">2026</div>
      </div>
  </div>

  <a-scene 
    mindar-image="imageTargetSrc: ./targets.mind; uiScanning: no; filterMinCF: 0.0001; filterBeta: 0.001;" 
    color-space="sRGB" 
    renderer="colorManagement: true, physicallyCorrectLights"  
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false">
    
    <a-assets>
      <a-asset-item id="student-model" src="3d/etudiant.glb"></a-asset-item>
      <a-asset-item id="school-model" src="3d/school.glb"></a-asset-item>
      <a-asset-item id="privehc-model" src="3d/school.glb"></a-asset-item>
      <a-asset-item id="public-model" src="3d/public.glb"></a-asset-item>
      <a-asset-item id="privesc-model" src="3d/prive_sc.glb"></a-asset-item>

      <!-- Model pour les chapeaux (filiÃ¨res) -->
      <a-asset-item id="hat-model" src="3d/hat.glb"></a-asset-item>
      
      <!-- Images pour les boutons -->
      <img id="graph-levels-img" src="affiche/graphique_niveaux.png">
      <img id="graph-status-img" src="affiche/statut_etablissements.png">
      <img id="graph-top6-img" src="affiche/6-etablissements.png">
      <img id="graph-evolution-img" src="affiche/etudiants-statut.png"> 
      <img id="graph-diplomes-img" src="affiche/type-diplomes.png">
      
      <!-- Image de fond pour les animations -->
      <img id="bg-animation" src="affiche/fond-1.png">
    </a-assets>

    <a-light type="ambient" intensity="1.0"></a-light>
    <a-light type="directional" position="2 4 5" intensity="1.2"></a-light>

    <a-camera position="0 0 0" look-controls="enabled: false">
      <a-entity cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 10000; objects: .clickable"></a-entity>
    </a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      
      <a-entity id="zone-graphique" position="-0.3 -0.375 0">

          <a-image id="overlay-levels-btn" src="#graph-levels-img" position="0 0 0.02" scale="0.4 0.37 1" class="clickable" onclick="launchLevels()"></a-image>
          <a-image id="overlay-status-btn" src="#graph-status-img" position="0.6 0.97 0.02" scale="0.4 0.48 1" class="clickable" onclick="launchStatus()"></a-image>
          <a-image id="overlay-top6-btn" src="#graph-top6-img" position="0.3 -0.45 0.02" scale="1 0.5 1" class="clickable" onclick="launchTop6()"></a-image>
          <a-image id="overlay-evolution-btn" src="#graph-evolution-img" position="0.3 0.43 0.02" scale="0.95 0.4 1" class="clickable" onclick="launchEvolution()"></a-image>
          <!-- Bouton pour les diplÃ´mes / filiÃ¨res -->
          <a-image id="overlay-diplomes-btn" src="#graph-diplomes-img" position="0.6 0 0.02" scale="0.4 0.38 1" class="clickable" onclick="launchDiplomes()"></a-image>

          <a-entity id="levels-scene-container" visible="false">
             <a-entity id="scene-niv5" position="0 -0.8 0"></a-entity>
             <a-entity id="scene-niv6" position="0 0 0"></a-entity>
             <a-entity id="scene-niv7" position="0 0.8 0"></a-entity>
          </a-entity>
          
         <a-entity id="status-scene-container" visible="false">
             <a-text value="STATUT DES 21 ETABLISSEMENTS" position="0 1.5 0" align="center" color="white" scale="0.8 0.8 0.8"></a-text>
             <a-entity id="status-legend" position="-1.5 0.8 0"></a-entity> 
             <a-entity id="district-private-hc" position="0 0.8 0"></a-entity>
             <a-entity id="district-public" position="0 0 0"></a-entity>
             <a-entity id="district-contract-sc" position="0 -0.8 0"></a-entity>
          </a-entity>

          <!-- Conteneur pour la visualisation des filiÃ¨res (chapeaux) -->
          <a-entity id="filieres-scene-container" visible="false" position="0 -0.25 0"></a-entity>
          
          <a-entity id="top6-scene-container" visible="false">
              <a-text id="top6-title" value="TOP 6 ETUDIANTS" position="0 1.0 0" align="center" color="white" scale="0.7 0.7 0.7"></a-text>
              <a-entity id="top6-buildings" position="0 0 0"></a-entity>
          </a-entity>

          <a-entity id="evolution-scene-container" visible="false">
              <a-entity id="evolution-crowd-anchor" position="0 -0.5 0"></a-entity>
              <a-text id="evolution-value-text" value="" position="0 1.5 0" align="center" color="white" scale="1.2 1.2 1.2"></a-text>
              <a-text id="evolution-title-text" value="ANNEE 2015" position="0 1.8 0" align="center" color="white" scale="0.6 0.6 0.6"></a-text>
          </a-entity>

      </a-entity>

    </a-entity>
  </a-scene>

  <script>
    // ================= DONNEES =================
    
    // TOP 6
    const TOP6_DATA = [
      { name: "Du Guesclin", students: 915, apprentis: 0 },
      { name: "IUT",         students: 465, apprentis: 107 }, 
      { name: "IFMS Beziers",students: 331, apprentis: 0 },
      { name: "Purple Campus",students: 0,  apprentis: 290 }, 
      { name: "Ruffel",      students: 10,  apprentis: 247 }, 
      { name: "Lycee M. Bloch",students: 232, apprentis: 0 }
    ];

    // EVOLUTION
    const EVOLUTION_DATA = {
        2015: { students: 2344, apprentis: 78 },
        2021: { students: 2758, apprentis: 153 },
        2026: { students: 2747, apprentis: 928 }
    };

    const COLORS = { STUDENT: "#C68F00", APPRENTI: "#FF8A65" };

    const STATUS_MAP = {
        'PRIVE HC': { model: '#privehc-model', count: 10, color: '#C52A28', title: 'Prive Hors Contrat' },
        'PUBLIC': { model: '#public-model', count: 8, color: '#7F5026', title: 'Public' },
        'PRIVE SC': { model: '#privesc-model', count: 3, color: '#892981', title: 'Prive Sous Contrat' }
    };
    const LEVEL_DATA = {
        NIV5: { formations: 48, students: 1303, color: '#F5A623', title: 'BAC+2', model: '#school-model' },
        NIV6: { formations: 37, students: 2044, color: '#4A90E2', title: 'BAC+3', model: '#school-model' },
        NIV7: { formations: 5, students: 328, color: '#50E3C2', title: 'BAC+5', model: '#school-model' }
    };

    const STUDENT_SCALE = 0.08; 
    const SCHOOL_FACTOR_LEVEL = 0.007; 
    const SCHOOL_MIN_SIZE = 0.2; 
    const BUILDING_SCALE = 0.15; 
    const SPACING = 0.5;
    const COLS = 4;

    // ================= ETAT =================
    
    let isApprentiModeTop6 = false;
    let currentEvolutionYear = 2015;
    let isApprentiModeEvolution = false;

    // ================= FONCTIONS UTILES =================

    function toggleCamera(show) {
        const video = document.querySelector('video');
        if (video) video.style.opacity = show ? '1' : '0';
    }

    function resetScenes() {
        document.querySelector('#levels-scene-container').setAttribute('visible', false);
        document.querySelector('#status-scene-container').setAttribute('visible', false);
        document.querySelector('#top6-scene-container').setAttribute('visible', false);
        document.querySelector('#evolution-scene-container').setAttribute('visible', false);
        
        document.querySelector('#scene-niv5').innerHTML = '';
        document.querySelector('#scene-niv6').innerHTML = '';
        document.querySelector('#scene-niv7').innerHTML = '';
        document.querySelector('#district-private-hc').innerHTML = '';
        document.querySelector('#district-public').innerHTML = '';
        document.querySelector('#district-contract-sc').innerHTML = '';
        document.querySelector('#status-legend').innerHTML = '';
        document.querySelector('#top6-buildings').innerHTML = '';
        document.querySelector('#evolution-crowd-anchor').innerHTML = '';
        const filieresParent = document.querySelector('#filieres-scene-container');
        if (filieresParent) {
            filieresParent.innerHTML = '';
            filieresParent.setAttribute('visible', false);
        }
        const filieresBg = document.querySelector('#filieres-bg');
        if (filieresBg && filieresBg.parentNode) filieresBg.parentNode.removeChild(filieresBg);
        
        document.querySelector('#switch-btn-top6').style.display = 'none';
        document.querySelector('#evolution-ui').style.display = 'none';
        
        document.querySelector('#overlay-levels-btn').setAttribute('visible', false);
        document.querySelector('#overlay-status-btn').setAttribute('visible', false);
        document.querySelector('#overlay-top6-btn').setAttribute('visible', false);
        document.querySelector('#overlay-evolution-btn').setAttribute('visible', false);
        document.querySelector('#overlay-diplomes-btn').setAttribute('visible', false);
        
        toggleCamera(false);
    }

    function showMainMenu() {
        toggleCamera(true);
        document.querySelector('#back-btn').style.display = 'none';
        document.querySelector('#overlay-levels-btn').setAttribute('visible', true);
        document.querySelector('#overlay-status-btn').setAttribute('visible', true);
        document.querySelector('#overlay-top6-btn').setAttribute('visible', true);
        document.querySelector('#overlay-evolution-btn').setAttribute('visible', true);
        document.querySelector('#overlay-diplomes-btn').setAttribute('visible', true);
    }

    // ================= LOGIQUE EVOLUTION (FOULE) =================

    window.launchEvolution = function() {
        resetScenes();
        document.querySelector('#back-btn').style.display = 'block';
        document.querySelector('#evolution-scene-container').setAttribute('visible', true);
        document.querySelector('#evolution-ui').style.display = 'block';
        
        currentEvolutionYear = 2015;
        isApprentiModeEvolution = false;
        
        updateEvolutionDisplay();
    };

    window.selectYear = function(year) {
        currentEvolutionYear = year;
        updateEvolutionDisplay();
    };

    window.toggleEvolutionType = function() {
        isApprentiModeEvolution = !isApprentiModeEvolution;
        updateEvolutionDisplay();
    };

    function updateEvolutionDisplay() {
        // UI Updates
        document.querySelectorAll('.year-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${currentEvolutionYear}`).classList.add('active');

        const typeBtn = document.getElementById('evo-type-btn');
        if (isApprentiModeEvolution) {
            typeBtn.innerHTML = "VOIR ETUDIANTS ðŸŽ“";
            typeBtn.classList.add('mode-apprenti-style');
            typeBtn.style.backgroundColor = COLORS.APPRENTI;
            typeBtn.style.color = "black";
        } else {
            typeBtn.innerHTML = "VOIR APPRENTIS ðŸ”„";
            typeBtn.classList.remove('mode-apprenti-style');
            typeBtn.style.backgroundColor = COLORS.STUDENT;
            typeBtn.style.color = "white";
        }

        const dataYear = EVOLUTION_DATA[currentEvolutionYear];
        const count = isApprentiModeEvolution ? dataYear.apprentis : dataYear.students;
        const color = isApprentiModeEvolution ? COLORS.APPRENTI : COLORS.STUDENT;

        // FOULE
        const anchor = document.querySelector('#evolution-crowd-anchor');
        anchor.innerHTML = '';
        
        const sceneContainer = document.querySelector('#evolution-scene-container');
        let existingBg = sceneContainer.querySelector('#evolution-bg');
        if (!existingBg) {
            addAnimationBackgroundWithId(sceneContainer, 'evolution-bg');
        }

        const MODEL_RATIO = 50; 
        let numModels = Math.ceil(count / MODEL_RATIO);
        if (count > 0 && numModels < 1) numModels = 1;

        const gridCols = 8; 
        const spacing = 0.15; 
        const totalWidth = Math.min(numModels, gridCols) * spacing;
        const totalDepth = Math.ceil(numModels / gridCols) * spacing;
        const startX = -totalWidth / 2;
        const startZ = -totalDepth / 2;

        for(let i = 0; i < numModels; i++) {
            const student = document.createElement('a-entity');
            student.setAttribute('gltf-model', '#student-model');
            const row = Math.floor(i / gridCols);
            const col = i % gridCols;
            const x = startX + (col * spacing);
            const z = startZ + (row * spacing);
            student.setAttribute('position', `${x} 0 ${z}`);
            const s = STUDENT_SCALE; 
            student.setAttribute('scale', '0 0 0'); 
            student.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
            student.setAttribute('animation', `property: scale; to: ${s} ${s} ${s}; dur: 500; delay: ${i * 20}; easing: easeOutBack`);
            anchor.appendChild(student);
        }

        // Textes
        const txtValue = document.querySelector('#evolution-value-text');
        const txtTitle = document.querySelector('#evolution-title-text');
        
        txtValue.setAttribute('value', count);
        txtValue.setAttribute('position', `0 1.2 0`); 
        
        let titleString = `ANNEE ${currentEvolutionYear}`;
        titleString += isApprentiModeEvolution ? "\n(APPRENTIS)" : "\n(ETUDIANTS)";
        txtTitle.setAttribute('value', titleString);
        txtTitle.setAttribute('color', color);
    }

    // ================= LOGIQUE TOP 6 =================

    window.toggleTop6Mode = function() {
        isApprentiModeTop6 = !isApprentiModeTop6; 
        const btn = document.querySelector('#switch-btn-top6');
        if (isApprentiModeTop6) {
            btn.innerHTML = "VOIR ETUDIANTS ðŸŽ“"; 
            btn.classList.add('mode-apprenti');
            btn.style.backgroundColor = COLORS.APPRENTI;
            btn.style.color = "black";
            btn.style.borderColor = "white";
        } else {
            btn.innerHTML = "VOIR APPRENTIS ðŸ”„";
            btn.classList.remove('mode-apprenti');
            btn.style.backgroundColor = "#2c3e50";
            btn.style.color = "white";
            btn.style.borderColor = COLORS.STUDENT;
        }
        buildTop6Viz();
    };

    window.launchTop6 = function() {
        resetScenes();
        document.querySelector('#back-btn').style.display = 'block';
        document.querySelector('#switch-btn-top6').style.display = 'block'; 
        document.querySelector('#top6-scene-container').setAttribute('visible', true);
        buildTop6Viz();
    };

    function buildTop6Viz() {
        const container = document.querySelector('#top6-buildings');
        const titleText = document.querySelector('#top6-title');
        container.innerHTML = ''; 

        addAnimationBackground(container);

        let currentColor = isApprentiModeTop6 ? COLORS.APPRENTI : COLORS.STUDENT;
        
        if (isApprentiModeTop6) {
            titleText.setAttribute('value', "TOP 6 (DONT APPRENTIS)");
            titleText.setAttribute('color', COLORS.APPRENTI);
        } else {
            titleText.setAttribute('value', "TOP 6 (ETUDIANTS UNIQUEMENT)");
            titleText.setAttribute('color', COLORS.STUDENT);
        }

        TOP6_DATA.forEach((data, index) => {
            const count = isApprentiModeTop6 ? data.apprentis : data.students;
            if (count <= 0) return;

            const x = (index * 0.35) - 0.9; 
            const HEIGHT_FACTOR = 0.0016;
            const finalHeight = Math.max(count * HEIGHT_FACTOR, 0.06);

            const wrapper = document.createElement('a-entity');
            wrapper.setAttribute('position', `${x} -0.5 0`);
            
            wrapper.setAttribute('procedural-building', `
                height: ${finalHeight}; 
                width: 0.25; 
                color: ${currentColor}; 
                offset: ${index}
            `);
            container.appendChild(wrapper);

            const text = document.createElement('a-text');
            text.setAttribute('value', `${count}\n${data.name}`);
            text.setAttribute('align', 'center');
            text.setAttribute('color', 'white');
            text.setAttribute('scale', '0.3 0.3 0.3');
            const textY = -0.5 + finalHeight + 0.15; 
            text.setAttribute('position', `${x} ${textY} 0`);
            container.appendChild(text);
        });
    }

    // ================= AUTRES LANCEMENTS =================

    window.launchLevels = function() {
        resetScenes();
        document.querySelector('#back-btn').style.display = 'block';
        document.querySelector('#levels-scene-container').setAttribute('visible', true);
        
        buildLevelViz('#scene-niv5', LEVEL_DATA.NIV5.title, LEVEL_DATA.NIV5.formations, LEVEL_DATA.NIV5.students, LEVEL_DATA.NIV5.color, '#school-model');
        buildLevelViz('#scene-niv6', LEVEL_DATA.NIV6.title, LEVEL_DATA.NIV6.formations, LEVEL_DATA.NIV6.students, LEVEL_DATA.NIV6.color, '#school-model'); 
        buildLevelViz('#scene-niv7', LEVEL_DATA.NIV7.title, LEVEL_DATA.NIV7.formations, LEVEL_DATA.NIV7.students, LEVEL_DATA.NIV7.color, '#school-model'); 
    };

    window.launchStatus = function() {
        resetScenes();
        document.querySelector('#back-btn').style.display = 'block';
        document.querySelector('#status-scene-container').setAttribute('visible', true);
        createStatusLegend();
        buildStatusViz('#district-private-hc', STATUS_MAP['PRIVE HC'].model, STATUS_MAP['PRIVE HC'].title, STATUS_MAP['PRIVE HC'].count, STATUS_MAP['PRIVE HC'].color); 
        buildStatusViz('#district-public', STATUS_MAP['PUBLIC'].model, STATUS_MAP['PUBLIC'].title, STATUS_MAP['PUBLIC'].count, STATUS_MAP['PUBLIC'].color);
        buildStatusViz('#district-contract-sc', STATUS_MAP['PRIVE SC'].model, STATUS_MAP['PRIVE SC'].title, STATUS_MAP['PRIVE SC'].count, STATUS_MAP['PRIVE SC'].color);
    };

    window.handleBackClick = function() {
        const parent = document.querySelector('#filieres-scene-container');
        const bg = document.querySelector('#filieres-bg');
        if (bg) {
            bg.setAttribute('animation__out', 'property: material.opacity; to: 0; dur: 250; easing: easeOutQuad');
            if (parent) parent.innerHTML = '';
            setTimeout(() => {
                if (bg.parentNode) bg.parentNode.removeChild(bg);
                resetScenes();
                showMainMenu();
            }, 300);
        } else {
            resetScenes();
            showMainMenu();
        }
    };

    function buildLevelViz(containerID, title, formationsCount, studentsCount, color, modelId) {
        const container = document.querySelector(containerID);
        container.innerHTML = '';
        
        addAnimationBackground(container);
        
        let finalScale = Math.max(formationsCount * SCHOOL_FACTOR_LEVEL, SCHOOL_MIN_SIZE);
        const school = document.createElement('a-entity');
        school.setAttribute('gltf-model', modelId); 
        school.setAttribute('scale', '0 0 0'); 
        school.setAttribute('position', '0 0 -0.2'); 
        school.setAttribute('animation', `property: scale; from: 0 0 0; to: ${finalScale} ${finalScale} ${finalScale}; dur: 2000; easing: easeOutElastic`);
        container.appendChild(school);
        const titleText = document.createElement('a-text');
        titleText.setAttribute('value', title);
        titleText.setAttribute('align', 'center'); 
        titleText.setAttribute('color', 'white');
        titleText.setAttribute('position', '0 0.5 0.5'); 
        titleText.setAttribute('scale', '0.5 0.5 0.5');
        container.appendChild(titleText);
        let avatarCount = Math.ceil(studentsCount / 200);
        const cols = 5; 
        for (let i = 0; i < avatarCount; i++) {
            const student = document.createElement('a-entity');
            student.setAttribute('gltf-model', '#student-model');
            student.setAttribute('scale', '0 0 0');
            const row = Math.floor(i / cols);
            const col = i % cols;
            const x = (col * 0.1) - (0.1 * (cols-1)/2);
            const z = 0.1 + row * 0.08;
            student.setAttribute('position', `${x} 0 ${z}`);
            student.setAttribute('rotation', `0 ${Math.random()*360} 0`);
            student.setAttribute('animation', `property: scale; from: 0 0 0; to: ${STUDENT_SCALE} ${STUDENT_SCALE} ${STUDENT_SCALE}; dur: 800; delay: ${i*50 + 500}; easing: easeOutBack`);
            container.appendChild(student);
        }
    }
    
    function buildStatusViz(containerID, modelID, title, count, color) {
        const container = document.querySelector(containerID);
        container.innerHTML = '';
        
        addAnimationBackground(container);
        
        for (let i = 0; i < count; i++) {
            const el = document.createElement('a-entity');
            el.setAttribute('gltf-model', modelID);
            el.setAttribute('scale', '0 0 0'); 
            const row = Math.floor(i / COLS);
            const col = i % COLS;
            const x = (col * SPACING) - (SPACING * (COLS - 1) / 2);
            const z = row * SPACING;
            el.setAttribute('position', `${x} 0.01 ${z}`);
            el.setAttribute('animation', `property: scale; from: 0 0 0; to: ${BUILDING_SCALE} ${BUILDING_SCALE} ${BUILDING_SCALE}; dur: 800; delay: ${i * 100}; easing: easeOutBack`);
            container.appendChild(el);
        }
    }
    
    function createStatusLegend() {
        const legendContainer = document.querySelector('#status-legend');
        legendContainer.innerHTML = '';
        const legendData = [STATUS_MAP['PRIVE HC'], STATUS_MAP['PUBLIC'], STATUS_MAP['PRIVE SC']];
        let y = 0;
        legendData.forEach((item) => {
            const box = document.createElement('a-box');
            box.setAttribute('color', item.color);
            box.setAttribute('scale', '0.1 0.1 0.01');
            box.setAttribute('position', `-0.3 ${y} 0`);
            legendContainer.appendChild(box);
            const txt = document.createElement('a-text');
            txt.setAttribute('value', item.title);
            txt.setAttribute('color', 'white');
            txt.setAttribute('scale', '0.35 0.35 0.35');
            txt.setAttribute('position', `0.1 ${y} 0`);
            legendContainer.appendChild(txt);
            y -= 0.2;
        });
    }
    
    // ================= FONCTION BACKGROUND POUR ANIMATIONS =================
    function addAnimationBackground(container) {
        const bg = document.createElement('a-plane');
        bg.setAttribute('id', 'anim-bg-' + Math.random());
        bg.setAttribute('width', '2.5');
        bg.setAttribute('height', '2.5');
        bg.setAttribute('position', '0 0 -0.5');
        bg.setAttribute('material', 'color: #000000; opacity: 0.7; transparent: true');
        container.appendChild(bg);
    }

    function addAnimationBackgroundWithId(container, id) {
        const bg = document.createElement('a-plane');
        bg.setAttribute('id', id);
        bg.setAttribute('width', '2.5');
        bg.setAttribute('height', '2.5');
        bg.setAttribute('position', '0 0 -0.5');
        bg.setAttribute('material', 'color: #000000; opacity: 0.7; transparent: true');
        container.appendChild(bg);
    }
    
    // ================= VISUALISATION FILIERES (CHAPEAUX) =================
    function buildFiliereGraph() {
        const FILIERES = [
            { name: "MÃ©dical, sanitaire et social", count: 1156 },
            { name: "Commerce, communication", count: 940 },
            { name: "NumÃ©rique", count: 484 },
            { name: "Lettres, langues, SHS", count: 450 },
            { name: "Industrie, artisanat", count: 295 },
            { name: "Gestion, comptabilitÃ©", count: 248 },
            { name: "Tourisme, hÃ´tellerie", count: 76 },
            { name: "Arts plastiques", count: 17 },
            { name: "Logistique", count: 9 }
        ];

        const parent = document.querySelector('#filieres-scene-container');
        if (!parent) return;
        parent.innerHTML = '';

        const maxVal = Math.max(...FILIERES.map(f => f.count)) || 1;
        const spacing = 0.75;
        const n = FILIERES.length;
        const startX = -((n - 1) * spacing) / 2;

        // Ajouter le fond
        addAnimationBackground(parent);

        FILIERES.forEach((f, i) => {
            const x = startX + i * spacing;

            const hat = document.createElement('a-entity');
            hat.setAttribute('gltf-model', '#hat-model');

            const rawScale = (f.count / maxVal);
            const SCALE_FACTOR = 0.5;
            let scaleVal = rawScale * SCALE_FACTOR;
            const minScale = 0.06;
            const maxScale = 0.55;
            scaleVal = Math.min(Math.max(scaleVal, minScale), maxScale);

            hat.setAttribute('scale', `0 0 0`);
            hat.setAttribute('position', `${x} 0.08 0.02`);
            hat.setAttribute('rotation', `0 ${Math.random() * 30 - 15} 0`);
            const hatDelay = 200 + i * 90;
            hat.setAttribute('animation', `property: scale; to: ${scaleVal} ${scaleVal} ${scaleVal}; dur: 1500; easing: easeOutElastic; delay: ${hatDelay}`);
            parent.appendChild(hat);

            const shortName = (f.name.length > 20) ? f.name.slice(0, 20) + 'â€¦' : f.name;
            const txt = document.createElement('a-text');
            txt.setAttribute('value', `${shortName}\n${f.count}`);
            txt.setAttribute('align', 'center');
            txt.setAttribute('color', 'white');
            txt.setAttribute('scale', '0.24 0.24 0.24');
            txt.setAttribute('position', `${x} -0.35 0.02`);
            parent.appendChild(txt);
        });
    }

    window.launchDiplomes = function() {
        resetScenes();
        document.querySelector('#back-btn').style.display = 'block';
        const parent = document.querySelector('#filieres-scene-container');
        parent.setAttribute('visible', true);
        toggleCamera(false);
        buildFiliereGraph();
    };

    window.startARExperience = function() {
        document.querySelector('#intro-screen').style.display = 'none';
        showMainMenu();
    };

    window.addEventListener('load', () => {
        document.querySelector('#back-btn').addEventListener('click', handleBackClick);
        // L'intro s'affiche automatiquement
    });
  </script>
</body>
</html>