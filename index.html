<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Immersion - Classroom</title>
  
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>
  
  <style> 
    /* Le fond reste noir, mais il sera cachÃ© par le modÃ¨le 3D de la classe */
    body { margin: 0; background-color: black; } 
    
    #back-btn {
        position: fixed;
        top: 20px; left: 50%; transform: translateX(-50%);
        padding: 12px 24px;
        background-color: #CC0000; color: white;
        font-family: sans-serif; font-weight: bold;
        border: 2px solid white; border-radius: 30px;
        z-index: 9999; display: none; cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>

  <div id="back-btn">RETOUR SCAN ðŸ“·</div>

  <a-scene 
    mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiError: yes;" 
    color-space="sRGB" 
    renderer="colorManagement: true; physicallyCorrectLights: true; shadowMapEnabled: true"  
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false">
    
    <a-assets>
      <a-asset-item id="student-model" src="3d/etudiant.glb"></a-asset-item>
      <a-asset-item id="school-model" src="3d/school.glb"></a-asset-item>
      <a-asset-item id="classroom-model" src="3d/int_school.glb"></a-asset-item>
      <img id="graph-img" src="affiche/graphique_niveaux.png">
    </a-assets>

    <a-light type="ambient" intensity="0.6" color="#FFF"></a-light>
    <a-light type="directional" position="2 4 -3" intensity="1" castShadow="true"></a-light>
    <a-light type="point" position="0 2 1" intensity="0.5" color="#FFDDC1" distance="10"></a-light>


    <a-camera position="0 0 0" look-controls="enabled: false">
      <a-entity cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 10000; objects: .clickable"></a-entity>
    </a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      
      <a-entity id="zone-graphique" position="-0.3 -0.375 0">

          <a-image 
            id="overlay-image"
            src="#graph-img" 
            position="0 0 0.02" 
            scale="0.4 0.3 1" 
            class="clickable"
            opacity="1"
            animation="property: scale; to: 0.42 0.32 1; dir: alternate; dur: 800; loop: true">
          </a-image>

          <a-entity id="scene-3d-container" visible="false">
              
              <a-entity 
                  id="classroom-environment"
                  gltf-model="#classroom-model"
                  /* POSITION : IMPORTANT !
                     On recule la classe (z = -2) pour qu'elle soit derriÃ¨re les graphiques.
                     On la baisse (y = -1.5) pour que le sol de la classe soit sous nos graphiques.
                  */
                  position="0 -1.5 -2"
                  /*
                     SCALE : IMPORTANT !
                     Il faudra peut-Ãªtre ajuster ces chiffres. Si la classe est trop petite,
                     augmente (ex: "5 5 5"). Si elle est trop grande, diminue.
                  */
                  scale="3 3 3"
                  /* Rotation si besoin (ex: "0 90 0" pour tourner la piÃ¨ce) */
                  rotation="0 0 0">
              </a-entity>

              <a-entity id="scene-niv5" position="0 -0.8 0"></a-entity>
              <a-entity id="scene-niv6" position="0 0 0"></a-entity>
              <a-entity id="scene-niv7" position="0 0.8 0"></a-entity>
          </a-entity>

      </a-entity>

    </a-entity>
  </a-scene>


  <script>
    // --- PARAMÃˆTRES ---
    const STUDENT_SCALE = 0.08; 
    const SCHOOL_FACTOR = 0.007; 
    const SCHOOL_MIN_SIZE = 0.2; 
    const SPACING = 0.09; 

    function buildLevel(containerID, title, formationsCount, studentsCount, color) {
      const container = document.querySelector(containerID);
      
      // Ã‰COLE
      let finalScale = formationsCount * SCHOOL_FACTOR;
      if (finalScale < SCHOOL_MIN_SIZE) finalScale = SCHOOL_MIN_SIZE;
      const school = document.createElement('a-entity');
      school.setAttribute('gltf-model', '#school-model');
      school.setAttribute('scale', '0 0 0'); 
      school.setAttribute('position', '0 0 -0.2'); 
      // Ajout d'ombres
      school.setAttribute('shadow', 'cast: true; receive: true');
      school.setAttribute('animation', `property: scale; from: 0 0 0; to: ${finalScale} ${finalScale} ${finalScale}; dur: 2000; easing: easeOutElastic`);
      container.appendChild(school);

      // TEXTE DROITE
      const textForm = document.createElement('a-text');
      textForm.setAttribute('value', `${formationsCount}\nFORMATIONS`);
      textForm.setAttribute('align', 'left'); 
      textForm.setAttribute('color', '#CC0000'); 
      textForm.setAttribute('position', `0.6 0.2 0`);
      textForm.setAttribute('scale', '0 0 0'); 
      textForm.setAttribute('animation', 'property: scale; from: 0 0 0; to: 0.5 0.5 0.5; dur: 1000; easing: easeOutBack; delay: 1500');
      container.appendChild(textForm);

      // TITRE GAUCHE (ChangÃ© en blanc pour ressortir dans la classe)
      const titleText = document.createElement('a-text');
      titleText.setAttribute('value', title);
      titleText.setAttribute('align', 'right'); 
      titleText.setAttribute('color', 'white'); 
      titleText.setAttribute('position', '-0.6 0.2 0'); 
      titleText.setAttribute('scale', '0.5 0.5 0.5');
      container.appendChild(titleText);

      // Ã‰TUDIANTS
      let avatarCount = Math.ceil(studentsCount / 200);
      const cols = 6; 
      for (let i = 0; i < avatarCount; i++) {
        const student = document.createElement('a-entity');
        student.setAttribute('gltf-model', '#student-model');
        student.setAttribute('scale', '0 0 0');
        // Ajout d'ombres
        student.setAttribute('shadow', 'cast: true; receive: true');
        const row = Math.floor(i / cols);
        const col = i % cols;
        const rowWidth = (Math.min(cols, avatarCount - (row * cols)) - 1) * SPACING;
        const x = (col * SPACING) - (rowWidth / 2);
        const z = 0.1 + (row * 0.08);
        student.setAttribute('position', `${x} 0 ${z}`);
        student.setAttribute('rotation', `0 ${Math.random() * 30 - 15} 0`);
        student.setAttribute('animation', `property: scale; from: 0 0 0; to: ${STUDENT_SCALE} ${STUDENT_SCALE} ${STUDENT_SCALE}; dur: 800; delay: ${i * 100}; easing: easeOutBack`);
        container.appendChild(student);
      }
    }

    // --- INTERACTION ---
    const imageBtn = document.querySelector('#overlay-image');
    const sceneContainer = document.querySelector('#scene-3d-container');
    const backBtn = document.querySelector('#back-btn');
    
    function toggleCamera(show) {
        const video = document.querySelector('video');
        if (video) video.style.opacity = show ? '1' : '0';
    }

    imageBtn.addEventListener('click', () => {
        imageBtn.setAttribute('visible', false);
        imageBtn.classList.remove('clickable');
        toggleCamera(false);

        sceneContainer.setAttribute('visible', true);
        backBtn.style.display = 'block';

        buildLevel('#scene-niv5', 'BAC+2', 48, 1303, '#F5A623'); 
        buildLevel('#scene-niv6', 'BAC+3', 37, 2044, '#4A90E2'); 
        buildLevel('#scene-niv7', 'BAC+5', 5, 328, '#50E3C2'); 
    });

    backBtn.addEventListener('click', () => {
        sceneContainer.setAttribute('visible', false);
        backBtn.style.display = 'none';
        
        document.querySelector('#scene-niv5').innerHTML = '';
        document.querySelector('#scene-niv6').innerHTML = '';
        document.querySelector('#scene-niv7').innerHTML = '';

        imageBtn.setAttribute('visible', true);
        imageBtn.classList.add('clickable');
        toggleCamera(true);
    });

  </script>
</body>
</html>